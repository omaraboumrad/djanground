version: '2.1'

volumes:
  media: {}
  static: {}

services:

    nginx:
        build: ./webserver/
        image: djanground/nginx
        volumes:
            - static:/opt/root/static
            - media:/opt/root/media
        ports:
            - 80:80
        depends_on:
            - backend
        links:
            - backend

    redis:
        image: redis:4.0.2-alpine

    executor:
        build: ./executor/
        image: djanground/executor
        command: /bin/true

    backend:
        build: ./backend/
        image: djanground/backend
        volumes:
            - ./backend:/app
        depends_on:
            - redis
        links:
            - redis
        ports:
            - 8000:8000
        command: python manage.py runserver 0.0.0.0:8000

    worker:
        image: djanground/backend
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./backend:/app
        depends_on:
            - redis
            - backend
        links:
            - redis
        command: rq worker --url redis://redis:6379

    # In this iteration, we'll poll. LIKE A BAWS!
    # monitor:
    #     image: djanground/backend
    #     depends_on:
    #         - redis
    #         - backend
    #     links:
    #         - redis
    #     command: python manage.py monitor
